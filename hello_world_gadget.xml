<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Dynamo"
    description="Gmail contextual gadget"
    height="50"
    author=""
    author_email="..."
    author_location="Netage">

    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>
    <Require feature="setprefs" />
    <Require feature="locked-domain" />
    
    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:MessageIDExtractor
      </Param>
    </Require>

  </ModulePrefs>

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
    <![CDATA[
     
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript">

        var prefKey = "userid";

        $(document).ready(function () {

            $("<input id='loginbtn' type='submit' name='loginbtn' value='Login' />").appendTo("#myForm");
            $("<input id='logoutbtn' type='submit' name='logoutbtn' value='Logout' />").appendTo("#myForm");
            $("<input id='quickAdd' type='submit' name='quickAdd' value='Quick Add' />").appendTo("#myForm");
            $("<input id='advancedAdd' type='submit' name='advancedAdd' value='Advanced Add' />").appendTo("#myForm");
            $("<input id='dddd' type='submit' name='dddd' value='dddd' />").appendTo("#myForm");
            
            $('<div id="formId" style="backgroud-color:red">Alalalala</div>').appendTo("#myForm");
            $('#formId').dialog({
                resizable: false,
                height: 140,
                modal: true,
                buttons: {
                    "Delete all items": function () {
                        $(this).dialog("close");
                    },
                    Cancel: function () {
                        $(this).dialog("close");
                    }
                }
            });
            
            $("<br />").appendTo("#myForm");
            $("<label id='msgid'></label>").appendTo("#myForm");

            showStatus();

            $('#advancedAdd').click(function () {
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + 'api/dynamo/GetInfo?uid=' + guid + '&msgid=' + getMessageId();

                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        var emailInfo = JSON.parse(data);
                        alert(emailInfo.Subject);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

                return false;
            });
            
            $('#quickAdd').click(function () {
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + 'api/dynamo/QuickAdd?uid=' + guid + '&msgid=' + getMessageId();

                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        alert(data);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

                return false;
            });

            $('#loginbtn').click(function () {
                var guid = getPref(prefKey);
                if (guid) return false;

                var dataValues = 'gmailLoginEmail=netage.developer@netagesolutions.com&dynamoLoginEmail=dynamoadmin@veli.com&dynamoPassord=veli.2014';
                var url = geturl() + 'api/login/get?' + dataValues;

                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        setPref(prefKey, data);
                        showStatus();
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

                return false;
            });

            $('#logoutbtn').click(function () {
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + '/api/logout/get?uid=' + guid;

                $.ajax({
                    type: 'GET',
                    cache: false,
                    url: url,
                    success: function (response) {
                        setPref(prefKey, null);
                        showStatus();
                    },
                    error: function (xhr) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });
                return false;
            });

            gadgets.window.adjustHeight(50);
        });

        function showStatus() {
            var guid = getPref(prefKey);
            if (guid) {
                $('#msgid').text('Logged In');
            }
            else {
                $('#msgid').text('Logged Out');
            }
        }

        function getPref(key) {
            var prefs = new gadgets.Prefs();
            return prefs.getString(key);
        }

        function setPref(key, val) {
            var prefs = new gadgets.Prefs();
            prefs.set(key, val);
        }

        function geturl() {
            return 'https://rome.netagesolutions.com:3434/';
        }

        function getMessageId() {
            var matches = google.contentmatch.getContentMatches();

            for (var match in matches)
                for (var key in matches[match])
                    if (key == 'message_id')
                        return matches[match][key];
        }


    </script>
      
      <form id="myForm">
      </form>
    ]]>
  </Content>
</Module>