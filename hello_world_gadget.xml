<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Dynamo"
    description="Gmail contextual gadget"
    height="50"
    author=""
    author_email="..."
    author_location="Netage">

    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>
    <Require feature="setprefs" />
    <Require feature="locked-domain" />
    
    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:MessageIDExtractor
      </Param>
    </Require>

  </ModulePrefs>

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
    <![CDATA[
     
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript">

        var prefKey = "userid";

                $(document).ready(function () {

            $("<input id='loginbtn' type='button' name='loginbtn' value='Login' />").appendTo("#myForm").button();
            //$("<input id='logoutbtn' type='submit' name='logoutbtn' value='Logout' />").appendTo("#myForm");
            $("<input id='quickAdd' type='button' name='quickAdd' value='Quick Add' />").appendTo("#myForm").button();
            $("<input id='advAddUpld' type='button' name='advAddUpld' value='Advanced Add' />").appendTo("#myForm").button();

            $("<br />").appendTo("#myForm");
            $("<label id='msgid'></label>").appendTo("#myForm");

            showStatus();

            $('#advAddUpld').click(function (e) {
                e.preventDefault();

                var dynamoData;
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + 'api/dynamo/GetInfo?uid=' + guid + '&msgid=' + getMessageId();

                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        dynamoData = JSON.parse(data);
                        //deserialize(data);

                        var targetUrl = geturl() + 'api/dynamo/Upload?uid=' + guid;
                        $('<div id="advFormId" class="modalDiv">').appendTo("#myForm").advform({ data: dynamoData, parentId: 'advFormId', targetUrl: targetUrl }).hide();
                        $('#advFormId').advform('show');
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

            });


            $('#quickAdd').click(function () {
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + 'api/dynamo/QuickAdd?uid=' + guid + '&msgid=' + getMessageId();

                console.log(url);
                
                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        alert(data);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

                return false;
            });

            $('#loginbtn').click(function () {
                var guid = getPref(prefKey);
                if (guid) return false;

                var dataValues = 'gmailLoginEmail=netage.developer@netagesolutions.com&dynamoLoginEmail=dynamo2@netagesolutions.com&dynamoPassord=dynamo';
                var url = geturl() + 'api/login/get?' + dataValues;

                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                        setPref(prefKey, data);
                        showStatus();
                        alert(data);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });

                return false;
            });

            $('#logoutbtn').click(function () {
                var guid = getPref(prefKey);
                if (!guid) return false;
                var url = geturl() + '/api/logout/get?uid=' + guid;

                $.ajax({
                    type: 'GET',
                    cache: false,
                    url: url,
                    success: function (response) {
                        setPref(prefKey, null);
                        showStatus();
                    },
                    error: function (xhr) {
                        alert(xhr.status + ' ' + xhr.response);
                    }
                });
                return false;
            });

            if (gadgets)
            {
                gadgets.window.adjustHeight(50);
            }
        });


        function showStatus() {
            var guid = getPref(prefKey);
            if (guid) {
                $('#msgid').text('Logged In');
            }
            else {
                $('#msgid').text('Logged Out');
            }
        }

        function getPref(key) {
            var prefs = new gadgets.Prefs();
            return prefs.getString(key);
        }

        function setPref(key, val) {
            var prefs = new gadgets.Prefs();
            prefs.set(key, val);
        }

        function geturl() {
            return 'https://rome.netagesolutions.com:3434/';
        }

        function getMessageId() {
            var matches = google.contentmatch.getContentMatches();

            for (var match in matches)
                for (var key in matches[match])
                    if (key == 'message_id')
                        return matches[match][key];
        }


    </script>
      
      <form id="myForm">
      </form>
    ]]>
  </Content>
</Module>