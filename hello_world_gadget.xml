<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Dynamo"
    description="third test 4"
    height="20"
    author="Veli"
    author_email="..."
    author_location="Netage">

    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>
    <Require feature="setprefs" />
    <Require feature="locked-domain" />
    
    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:MessageIDExtractor
      </Param>
    </Require>

  </ModulePrefs>

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
    <![CDATA[
      <!-- Start with Single Sign-On -->

         <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            var prefKey = "userid";

            $("<input id='loginbtn' type='submit' name='loginbtn' value='Login' />").appendTo("#myForm");
            $("<input id='logoutbtn' type='submit' name='logoutbtn' value='Logout' />").appendTo("#myForm");
            $("<label id='msgid'></label>").appendTo("#myForm");

            $('#loginbtn').click(function () {
            
                var dataValues = 'gmailLoginEmail=netage.developer@netagesolutions.com&dynamoLoginEmail=dynamoadmin@veli.com&dynamoPassord=veli.2014';
                var url = geturl() + 'api/login?' + dataValues;
                alert(url);
                
                $.ajax({
                    type: 'GET',
                    cache: false,
                    async: true,
                    url: url,
                    success: function (data) {
                      alert(data)          
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                      alert(xhr.status)
                    }
              });
              
              return false;
            });

            $('#logoutbtn').click(function () {
                var guid = getPref(prefKey);
                if (!guid)
                    return false;

                var dataValues = 'uid=' + guid;
                $.ajax({
                    type: 'GET',
                    data: dataValues,
                    cache: false,
                    contentType: "application/json",
                    dataType: "jsonp",
                    url: geturl() + '/api/logout',
                    success: function (response) {
                        //Output result on success
                        setPref(prefKey, null);
                        alert(response.success);
                    },
                    error: function (xhr) {
                        alert(xhr.status);
                    }
                });
                return false;
            });

            //gadgets.window.adjustHeight(20);
        });

        function getPref(key) {
            var prefs = new gadgets.Prefs();
            return prefs.getString(key);
        }

        function setPref(key, val) {
            var prefs = new gadgets.Prefs();
            prefs.set(key, val);
        }

        function geturl() {
            return 'https://rome.netagesolutions.com:3434/';
        }

    </script>
      
      <form id="myForm">
      </form>
    ]]>
  </Content>
</Module>